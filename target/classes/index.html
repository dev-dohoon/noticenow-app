<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NoticeNow - ë‚˜ë§Œì˜ ê³µê³  ì•Œë¦¬ë¯¸</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .view { transition: opacity 0.3s ease-in-out; }
        .hidden-view { opacity: 0; position: absolute; pointer-events: none; }
        #notification-log::-webkit-scrollbar { width: 6px; }
        #notification-log::-webkit-scrollbar-track { background: #f1f1f1; }
        #notification-log::-webkit-scrollbar-thumb { background: #888; border-radius: 3px; }
        #notification-log::-webkit-scrollbar-thumb:hover { background: #555; }
    </style>
</head>
<body class="bg-gray-50 flex items-center justify-center min-h-screen">

<div class="w-full max-w-6xl mx-auto p-4">
    <!-- ë¡œê·¸ì¸ í™”ë©´ -->
    <div id="login-view" class="view">
        <div class="bg-white rounded-2xl shadow-lg p-8 text-center max-w-xl mx-auto">
            <h1 class="text-4xl font-bold text-gray-800">ğŸš€ NoticeNow</h1>
            <p class="text-gray-500 mt-2 mb-8">í•™ë²ˆì„ ì…ë ¥í•˜ì—¬ ì‹œì‘í•˜ì„¸ìš”.</p>
            <div class="flex flex-col sm:flex-row gap-3">
                <input id="studentIdInput" type="text" placeholder="ì˜ˆ: 250101" maxlength="6"
                       class="flex-grow w-full px-4 py-3 text-gray-700 bg-gray-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button id="loginButton"
                        class="w-full sm:w-auto px-6 py-3 font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700 whitespace-nowrap">
                    ë¡œê·¸ì¸
                </button>
            </div>
        </div>
    </div>

    <!-- ë©”ì¸ í™”ë©´ (ë¡œê·¸ì¸ í›„ ë³´ì„) -->
    <div id="main-view" class="view hidden-view">
        <div class.grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- ì™¼ìª½ ì»¬ëŸ¼: ì‚¬ì´íŠ¸ ê´€ë¦¬ -->
        <div class="bg-white rounded-2xl shadow-lg p-8">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h2 class="text-2xl font-bold text-gray-800">ë‚´ ì•Œë¦¼ ì‚¬ì´íŠ¸</h2>
                    <p id="welcomeMessage" class="text-gray-500 text-sm"></p>
                </div>
                <button id="logoutButton" class="text-sm text-gray-500 hover:text-red-500">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
            <div id="site-list" class="space-y-3 mb-6 min-h-[120px]"></div>
            <div id="add-site-form" class="bg-gray-50 p-4 rounded-lg">
                <h3 class="font-semibold mb-3 text-gray-700">ìƒˆ ì‚¬ì´íŠ¸ ì¶”ê°€ (ìµœëŒ€ 3ê°œ)</h3>
                <div class="space-y-3">
                    <input id="siteNameInput" type="text" placeholder="ì´ë¦„ (ì˜ˆ: ì „ë‚¨ëŒ€ ê³µì§€)" class="w-full px-3 py-2 bg-white rounded-md border">
                    <input id="siteUrlInput" type="url" placeholder="URL (ì˜ˆ: https://...)" class="w-full px-3 py-2 bg-white rounded-md border">
                    <button id="addSiteButton" class="w-full px-4 py-2 font-semibold text-white bg-green-600 rounded-md hover:bg-green-700">
                        ì¶”ê°€í•˜ê¸°
                    </button>
                </div>
            </div>
            <p id="errorMessage" class="text-red-500 text-sm mt-2 text-center"></p>
        </div>

        <!-- ì˜¤ë¥¸ìª½ ì»¬ëŸ¼: ì‹¤ì‹œê°„ ì•Œë¦¼ ë¡œê·¸ -->
        <div class="bg-white rounded-2xl shadow-lg p-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">ì‹¤ì‹œê°„ ì•Œë¦¼ ë¡œê·¸</h2>
            <div id="notification-log" class="h-96 overflow-y-auto space-y-3 pr-2"></div>
        </div>
    </div>
</div>
</div>

<script>
    const loginView = document.getElementById('login-view');
    const mainView = document.getElementById('main-view');
    const studentIdInput = document.getElementById('studentIdInput');
    const loginButton = document.getElementById('loginButton');
    const logoutButton = document.getElementById('logoutButton');
    const welcomeMessage = document.getElementById('welcomeMessage');
    const siteList = document.getElementById('site-list');
    const siteNameInput = document.getElementById('siteNameInput');
    const siteUrlInput = document.getElementById('siteUrlInput');
    const addSiteButton = document.getElementById('addSiteButton');
    const addSiteForm = document.getElementById('add-site-form');
    const errorMessage = document.getElementById('errorMessage');
    const notificationLog = document.getElementById('notification-log');

    let currentStudentId = null;
    let notificationInterval = null;

    function isValidUrl(string) {
        try { new URL(string); return true; } catch (_) { return false; }
    }

    function getLogs(studentId) { return JSON.parse(localStorage.getItem(`logs_${studentId}`)) || []; }
    function saveLog(studentId, newLog) {
        const logs = getLogs(studentId);
        logs.unshift(newLog);
        localStorage.setItem(`logs_${studentId}`, JSON.stringify(logs));
    }

    function renderLogs(logs) {
        notificationLog.innerHTML = '';
        if (logs.length === 0) {
            notificationLog.innerHTML = `<p class="text-center text-gray-400 p-4">ìƒˆë¡œìš´ ê³µì§€ ì•Œë¦¼ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>`;
        } else {
            logs.forEach(log => {
                const logEntry = document.createElement('div');
                logEntry.className = 'bg-gray-50 rounded-lg p-3 border border-gray-200';
                logEntry.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="w-0 flex-1">
                            <p class="text-xs font-medium text-gray-900">[${log.siteName}]</p>
                            <p class="mt-1 text-sm text-gray-600">${log.title}</p>
                        </div>
                        <p class="ml-3 text-xs text-gray-400">${log.time}</p>
                    </div>`;
                notificationLog.appendChild(logEntry);
            });
        }
    }

    function renderSites(sites) {
        siteList.innerHTML = '';
        errorMessage.textContent = '';
        if (sites.length === 0) {
            siteList.innerHTML = '<p class="text-center text-gray-400 p-4">ë“±ë¡ëœ ì‚¬ì´íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        } else {
            sites.forEach(site => {
                const siteElement = document.createElement('div');
                siteElement.className = 'flex items-center justify-between bg-white p-3 rounded-md border';
                siteElement.innerHTML = `
                    <div>
                        <p class="font-semibold text-gray-800">${site.name}</p>
                        <a href="${site.url}" target="_blank" class="text-xs text-blue-500 truncate">${site.url}</a>
                    </div>
                    <button class="delete-button text-red-400 hover:text-red-600 font-bold p-2" data-url="${btoa(site.url)}">X</button>`;
                siteList.appendChild(siteElement);
            });
        }
        addSiteForm.style.display = sites.length >= 3 ? 'none' : 'block';
    }

    function switchView(showLogin) {
        if (showLogin) {
            loginView.classList.remove('hidden-view');
            mainView.classList.add('hidden-view');
        } else {
            loginView.classList.add('hidden-view');
            mainView.classList.remove('hidden-view');
        }
    }

    async function apiRequest(endpoint, params = {}) {
        const url = `/api/${endpoint}?` + new URLSearchParams(params).toString();
        try {
            const response = await fetch(url);
            const data = await response.json();
            if (!response.ok) throw new Error(data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜');
            errorMessage.textContent = '';
            return data;
        } catch (error) {
            errorMessage.textContent = error.message;
            return null;
        }
    }

    async function checkNewNotifications() {
        if (!currentStudentId) return;
        const newNotifications = await apiRequest('get-notifications', { studentId: currentStudentId });
        if (newNotifications && newNotifications.length > 0) {
            console.log(`ë¶€ì¬ì¤‘ ì•Œë¦¼ ${newNotifications.length}ê°œ ìˆ˜ì‹ :`, newNotifications);
            newNotifications.reverse().forEach(log => saveLog(currentStudentId, log));
            renderLogs(getLogs(currentStudentId));
        }
    }

    loginButton.addEventListener('click', async () => {
        const studentId = studentIdInput.value.trim();
        if (studentId.length !== 6) {
            alert('í•™ë²ˆì€ 6ìë¦¬ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return;
        }
        const sites = await apiRequest('login', { studentId });
        if (sites !== null) {
            currentStudentId = studentId;
            welcomeMessage.textContent = `${currentStudentId}ë‹˜, í™˜ì˜í•©ë‹ˆë‹¤.`;
            renderSites(sites);
            renderLogs(getLogs(currentStudentId)); // Load persistent logs first
            switchView(false);

            // Check for missed notifications immediately after login and then periodically
            checkNewNotifications();
            if (notificationInterval) clearInterval(notificationInterval);
            notificationInterval = setInterval(checkNewNotifications, 10000); // 10ì´ˆë§ˆë‹¤ í™•ì¸
        }
    });

    logoutButton.addEventListener('click', () => {
        if (notificationInterval) clearInterval(notificationInterval);
        currentStudentId = null;
        studentIdInput.value = '';
        notificationLog.innerHTML = '';
        switchView(true);
    });

    addSiteButton.addEventListener('click', async () => {
        const siteName = siteNameInput.value.trim();
        const siteUrl = siteUrlInput.value.trim();
        if (!siteName || !siteUrl) { errorMessage.textContent = 'ì´ë¦„ê³¼ URLì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.'; return; }
        if (!isValidUrl(siteUrl)) { errorMessage.textContent = 'ì˜¬ë°”ë¥¸ URL í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.'; return; }

        const sites = await apiRequest('add-site', { studentId: currentStudentId, siteName, siteUrlB64: btoa(siteUrl) });
        if (sites !== null) {
            siteNameInput.value = '';
            siteUrlInput.value = '';
            renderSites(sites);
        }
    });

    siteList.addEventListener('click', async (event) => {
        if (event.target.classList.contains('delete-button')) {
            const siteUrlB64 = event.target.dataset.url;
            if (confirm(`ì‚¬ì´íŠ¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                const sites = await apiRequest('delete-site', { studentId: currentStudentId, siteUrlB64 });
                if (sites !== null) {
                    renderSites(sites);
                }
            }
        }
    });
</script>
</body>
</html>